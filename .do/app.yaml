name: achtung-die-kurve
region: nyc

services:
  # WebSocket Server
  - name: websocket-server
    dockerfile_path: server/Dockerfile
    github:
      branch: main
      deploy_on_push: true
    health_check:
      http_path: /socket.io/socket.io.js
      success_codes:
        - 200
        - 404
    http_port: 3001
    instance_count: 1
    instance_size_slug: basic-xxs
    routes:
      - path: /socket.io
    environment_slug: node-js
    envs:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3001"
      - key: CORS_ORIGIN
        value: "*"

  # Static Site (Client)
  - name: client
    dockerfile_path: Dockerfile
    github:
      branch: main
      deploy_on_push: true
    health_check:
      http_path: /health
    http_port: 80
    instance_count: 1
    instance_size_slug: basic-xxs
    routes:
      - path: /
    environment_slug: node-js
    build_command: |
      node --version
      npm --version
      rm -rf node_modules package-lock.json
      npm install
      npm run build
    envs:
      - key: NODE_ENV
        value: production
      - key: VITE_WEBSOCKET_URL
        value: ${websocket-server.PUBLIC_URL}
      - key: NODE_OPTIONS
        value: "--max-old-space-size=8192"
      - key: NODE_VERSION
        value: "24.2.0"
